# ğŸ§® LangGraph æ™ºèƒ½è¡¨è¾¾å¼è®¡ç®—å™¨

åŸºäº LangGraph å’Œå¤šAgentæ¶æ„çš„æ™ºèƒ½æ•°å­¦è¡¨è¾¾å¼è®¡ç®—å™¨ï¼Œæ”¯æŒæ‹¬å·è¿ç®—å’Œè¯¦ç»†çš„æ‰§è¡Œæµç¨‹å¯è§†åŒ–ã€‚

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

æœ¬é¡¹ç›®æ¼”ç¤ºäº†å¦‚ä½•ä½¿ç”¨ LangGraph æ„å»ºä¸€ä¸ªå¤æ‚çš„å¤šAgentè®¡ç®—ç³»ç»Ÿï¼Œå°†æ•°å­¦è¡¨è¾¾å¼çš„è§£æã€è·¯ç”±å’Œè®¡ç®—åˆ†ç¦»åˆ°ä¸åŒçš„ä¸“ç”¨Agentä¸­ã€‚ç³»ç»Ÿèƒ½å¤Ÿï¼š

- ğŸ” **æ™ºèƒ½è§£æ**ï¼šè‡ªåŠ¨è¯†åˆ«æ•°å­¦è¡¨è¾¾å¼ä¸­çš„è¿ç®—ä¼˜å…ˆçº§ï¼ˆæ‹¬å·ä¼˜å…ˆï¼‰
- ğŸ¤– **å¤šAgentåä½œ**ï¼šä¸“ç”¨çš„åŠ æ³•å’Œå‡æ³•Agentåˆ†å·¥åˆä½œ
- ğŸ—ºï¸ **å¯è§†åŒ–æµç¨‹**ï¼šè¯¦ç»†å±•ç¤ºæ¯ä¸ªèŠ‚ç‚¹çš„æ‰§è¡Œè¿‡ç¨‹å’ŒAgentè°ƒç”¨
- ğŸ”„ **å¾ªç¯è®¡ç®—**ï¼šè‡ªåŠ¨å¤„ç†å¤æ‚è¡¨è¾¾å¼çš„é€æ­¥åŒ–ç®€

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### æ ¸å¿ƒç»„ä»¶

```
ğŸ“ demo_work/
â”œâ”€â”€ ğŸ¤– agents/           # Agentæ¨¡å—
â”‚   â”œâ”€â”€ base_agent.py    # åŸºç¡€Agentç±»
â”‚   â”œâ”€â”€ plus_agent.py    # åŠ æ³•ä¸“ç”¨Agent
â”‚   â””â”€â”€ subtract_agent.py # å‡æ³•ä¸“ç”¨Agent
â”œâ”€â”€ ğŸ› ï¸ tools/           # å·¥å…·æ¨¡å—
â”‚   â”œâ”€â”€ base_tool.py     # å·¥å…·æ³¨å†Œå’Œè°ƒç”¨æ¡†æ¶
â”‚   â”œâ”€â”€ plus_tool.py     # åŠ æ³•è®¡ç®—å·¥å…·
â”‚   â””â”€â”€ subtract_tool.py # å‡æ³•è®¡ç®—å·¥å…·
â”œâ”€â”€ ğŸ—ºï¸ graphs/          # å›¾ç»“æ„æ¨¡å—
â”‚   â”œâ”€â”€ base_graph.py    # åŸºç¡€å›¾ç±»ï¼ˆLangGraphåŒ…è£…å™¨ï¼‰
â”‚   â””â”€â”€ compute_graph.py # è®¡ç®—å›¾å®ç°
â”œâ”€â”€ ğŸ“Š states/           # çŠ¶æ€ç®¡ç†
â”‚   â””â”€â”€ multi_agent_state.py
â””â”€â”€ ğŸ§ª tests/           # æµ‹è¯•æ¨¡å—
```

### è®¡ç®—å›¾èŠ‚ç‚¹

- **ROUTER**: è¡¨è¾¾å¼è§£æå’Œè·¯ç”±åˆ†å‘ä¸­å¿ƒ
- **PLUS**: æ™®é€šåŠ æ³•è¿ç®—èŠ‚ç‚¹ï¼ˆè°ƒç”¨ PLUS_AGENTï¼‰
- **SUBTRACT**: æ™®é€šå‡æ³•è¿ç®—èŠ‚ç‚¹ï¼ˆè°ƒç”¨ SUBTRACT_AGENTï¼‰
- **PLUS_BRACKET**: æ‹¬å·å†…åŠ æ³•è¿ç®—èŠ‚ç‚¹ï¼ˆè°ƒç”¨ PLUS_AGENTï¼‰
- **SUBTRACT_BRACKET**: æ‹¬å·å†…å‡æ³•è¿ç®—èŠ‚ç‚¹ï¼ˆè°ƒç”¨ SUBTRACT_AGENTï¼‰

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒå‡†å¤‡

1. **å®‰è£…ä¾èµ–**
```bash
pip install -r requirements.txt
```

2. **é…ç½®APIå¯†é’¥**
åˆ›å»º `.env` æ–‡ä»¶å¹¶æ·»åŠ ï¼š
```env
DASHSCOPE_API_KEY=your_api_key_here
```

### è¿è¡Œç¤ºä¾‹

```bash
cd demo_work
python test_compute_graph.py
```

## ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹

### åŸºç¡€è¿ç®—
```python
# ç®€å•åŠ æ³•
3+5  # è¾“å‡º: 8

# ç®€å•å‡æ³•
10-3  # è¾“å‡º: 7
```

### å¤æ‚è¡¨è¾¾å¼
```python
# æ‹¬å·è¿ç®—
(3+5)-2     # è¾“å‡º: 6
((3+5)-2)+1 # è¾“å‡º: 7

# è¿ç»­è¿ç®—
10-3+2      # è¾“å‡º: 9
```

## ğŸ” æ‰§è¡Œæµç¨‹æ¼”ç¤º

å½“æ‚¨è¾“å…¥è¡¨è¾¾å¼ `(3+5)-2+1` æ—¶ï¼Œç³»ç»Ÿä¼šæ˜¾ç¤ºè¯¦ç»†çš„æ‰§è¡Œè¿‡ç¨‹ï¼š

```
============================================================
ğŸš€ èŠ‚ç‚¹æ‰§è¡Œ: ROUTER (è·¯ç”±å™¨)
ğŸ“ æ­¥éª¤ 1: åˆ†æè¡¨è¾¾å¼ '(3+5)-2+1'
============================================================
ğŸ” è·¯ç”±å™¨åˆ†æ: æ‹¬å·å†…åŠ æ³•è¿ç®—: 3 + 5
ğŸ“ è·¯ç”±å™¨å†³ç­–: åˆ†å‘åˆ° PLUS_BRACKET èŠ‚ç‚¹
â¡ï¸  ä¸‹ä¸€æ­¥: æ‰§è¡Œ plus_bracket èŠ‚ç‚¹

============================================================
ğŸš€ èŠ‚ç‚¹æ‰§è¡Œ: PLUS_BRACKET (æ‹¬å·å†…åŠ æ³•èŠ‚ç‚¹)
ğŸ§® å‡†å¤‡è®¡ç®—: 3 + 5
============================================================
ğŸ“ è°ƒç”¨ Agent: PLUS_AGENT
ğŸ“ è¾“å…¥å‚æ•°: "3+5"
ğŸ¤– Agent åŸå§‹è¾“å‡º: 8
ğŸ’¡ æå–çš„è®¡ç®—ç»“æœ: 8
âœ… Agent è°ƒç”¨æˆåŠŸ!
ğŸ”„ è¡¨è¾¾å¼æ›´æ–°: '(3+5)-2+1' â†’ '8-2+1'
â¡ï¸  ä¸‹ä¸€æ­¥: è¿”å› ROUTER èŠ‚ç‚¹ç»§ç»­åˆ†æ
```

## ğŸ›ï¸ æŠ€æœ¯æ¶æ„

### Agentç³»ç»Ÿ

#### BaseAgent
æ‰€æœ‰Agentçš„åŸºç¡€ç±»ï¼Œæä¾›ç»Ÿä¸€çš„æ¥å£å’Œé…ç½®ç®¡ç†ã€‚

#### PlusAgent
```python
ä¸“ç”¨åŠ æ³•Agentï¼Œç‰¹ç‚¹ï¼š
- æ¨¡å‹: qwen-plus
- å·¥å…·: plus_tool (ç²¾ç¡®åˆ°å°æ•°ç‚¹å3ä½)
- æç¤º: ä¸“é—¨ä¼˜åŒ–çš„åŠ æ³•è®¡ç®—æç¤ºè¯
```

#### SubtractAgent
```python
ä¸“ç”¨å‡æ³•Agentï¼Œç‰¹ç‚¹ï¼š
- æ¨¡å‹: qwen-plus  
- å·¥å…·: subtract_tool (ç²¾ç¡®åˆ°å°æ•°ç‚¹å3ä½)
- æç¤º: ä¸“é—¨ä¼˜åŒ–çš„å‡æ³•è®¡ç®—æç¤ºè¯
```

### å·¥å…·ç³»ç»Ÿ

#### å·¥å…·æ³¨å†Œæœºåˆ¶
```python
@register_tool("plus", "è®¡ç®—ä¸¤ä¸ªæµ®ç‚¹æ•°çš„å’Œ", PlusSchema)
def plus_tool(a: float, b: float) -> float:
    return round(a + b, 3)
```

#### ç»Ÿä¸€è°ƒç”¨æ¥å£
```python
# è°ƒç”¨å·¥å…·å¹¶è·å–ç»“æ„åŒ–ç»“æœ
msg = invoke_tool("plus", {"a": 1.5, "b": 2.3})
# ToolMessage(tool='plus', success=True, result=3.8)
```

### å›¾ç»“æ„ç³»ç»Ÿ

#### BaseGraph
LangGraphçš„è½»é‡çº§åŒ…è£…å™¨ï¼Œç‰¹ç‚¹ï¼š
- ğŸ”§ **ç»“æ„ä¸åŠŸèƒ½åˆ†ç¦»**ï¼šå…ˆå®šä¹‰æ‹“æ‰‘ï¼Œåç»‘å®šå‡½æ•°
- ğŸ¯ **ç±»å‹å®‰å…¨**ï¼šå®Œæ•´çš„TypedDictçŠ¶æ€ç®¡ç†
- ğŸ”„ **çµæ´»ç¼–è¯‘**ï¼šæ”¯æŒæ¡ä»¶è¾¹å’Œå¤æ‚è·¯ç”±

#### CalcState
```python
class CalcState(TypedDict, total=False):
    expr: str          # å½“å‰è¡¨è¾¾å¼
    left: str          # å·¦æ“ä½œæ•°  
    right: str         # å³æ“ä½œæ•°
    route: str         # è·¯ç”±å†³ç­–
    span: tuple        # æ“ä½œä½ç½®
    result: str        # æœ€ç»ˆç»“æœ
    op_type: str       # æ“ä½œç±»å‹ï¼ˆbracket/normalï¼‰
    step: int          # æ­¥éª¤ç¼–å·
    operation_log: str # æ“ä½œæ—¥å¿—
```

## ğŸ”„ æ‰§è¡Œæµç¨‹è¯¦è§£

### 1. è¡¨è¾¾å¼è§£æ
```python
def parse_next_op(expr: str):
    # ä¼˜å…ˆå¤„ç†æ‹¬å·å†…è¡¨è¾¾å¼
    bracket_match = re.search(r'\(([^()]+)\)', expr)
    if bracket_match:
        # è§£ææ‹¬å·å†…çš„è¿ç®—
        # è¿”å›: left, op, right, span, "bracket"
    
    # å¤„ç†æ™®é€šè¿ç®—
    match = re.search(r'(-?\d+(?:\.\d+)?)\s*([+-])\s*(-?\d+(?:\.\d+)?)', expr)
    # è¿”å›: left, op, right, span, "normal"
```

### 2. è·¯ç”±å†³ç­–
```python
def condition_router(state: CalcState) -> str:
    route = state.get("route", "end")
    # è¿”å›: "plus", "subtract", "plus_bracket", "subtract_bracket", "end"
    return route
```

### 3. è¡¨è¾¾å¼æ›´æ–°
```python
def _update_expression(state: CalcState, result: str) -> CalcState:
    # æ ¹æ®op_typeå†³å®šæ›´æ–°ç­–ç•¥
    if state.get("op_type") == "bracket":
        # æ›¿æ¢æ•´ä¸ªæ‹¬å·
        new_expr = expr[:bracket_start] + result + expr[bracket_end:]
    else:
        # æ™®é€šæ›¿æ¢
        new_expr = expr[:start] + result + expr[end:]
    return {"expr": new_expr}
```

## ğŸ¯ ç‰¹è‰²åŠŸèƒ½

### 1. å®æ—¶æµç¨‹è¿½è¸ª
- âœ… èŠ‚ç‚¹æ‰§è¡Œé¡ºåºå¯è§†åŒ–
- âœ… Agentè°ƒç”¨è¯¦æƒ…å±•ç¤º  
- âœ… è¡¨è¾¾å¼å˜åŒ–è¿½è¸ª
- âœ… é”™è¯¯å¤„ç†å’Œå¤‡ç”¨è®¡ç®—

### 2. äº¤äº’å¼è®¡ç®—å™¨
```python
ğŸ‰ æ¬¢è¿ä½¿ç”¨æ™ºèƒ½è¡¨è¾¾å¼è®¡ç®—å™¨ï¼
ğŸ’¡ æ”¯æŒæ‹¬å·è¿ç®—ï¼Œä¾‹å¦‚: (3+5)-2+1
ğŸ’¡ è¾“å…¥ 'q' é€€å‡º

è¯·è¾“å…¥æ•°å­¦è¡¨è¾¾å¼: (10-3)+2
# æ˜¾ç¤ºè¯¦ç»†æ‰§è¡Œè¿‡ç¨‹...
# æœ€ç»ˆç»“æœ: 9
```

### 3. æ‰¹é‡æµ‹è¯•
```python
test_expressions = [
    "3+5",           # ç®€å•åŠ æ³•
    "(3+5)-2",       # æ‹¬å·ä¼˜å…ˆ
    "((3+5)-2)+1",   # åµŒå¥—æ‹¬å·
    "10-3+2"         # è¿ç»­è¿ç®—
]
```

## ï¿½ï¿½ï¿½ï¸ æ‰©å±•æŒ‡å—

### æ·»åŠ æ–°è¿ç®—
1. **åˆ›å»ºå·¥å…·**
```python
@register_tool("multiply", "è®¡ç®—ä¸¤æ•°ä¹˜ç§¯", MultiplySchema)
def multiply_tool(a: float, b: float) -> float:
    return round(a * b, 3)
```

2. **åˆ›å»ºAgent**
```python
class MultiplyAgent(BaseAgent):
    def __init__(self, **kwargs):
        super().__init__(
            model="qwen-plus",
            tools=[multiply_tool],
            prompt="ä¸“é—¨çš„ä¹˜æ³•è®¡ç®—åŠ©æ‰‹..."
        )
```

3. **æ‰©å±•è§£æå™¨**
```python
# åœ¨ parse_next_op ä¸­æ·»åŠ ä¹˜æ³•åŒ¹é…
op_match = re.search(r'(-?\d+(?:\.\d+)?)\s*([+\-*/])\s*(-?\d+(?:\.\d+)?)', expr)
```

4. **æ·»åŠ å›¾èŠ‚ç‚¹**
```python
multiply_node = Node("multiply", func=run_multiply)
compute_graph.add_node(multiply_node)
```

### è‡ªå®šä¹‰çŠ¶æ€
```python
class CustomCalcState(CalcState):
    history: List[str]    # è®¡ç®—å†å²
    precision: int        # ç²¾åº¦æ§åˆ¶
    metadata: Dict        # å…ƒæ•°æ®
```

## ğŸ“Š æ€§èƒ½ç‰¹ç‚¹

- âš¡ **é«˜æ•ˆè§£æ**ï¼šæ­£åˆ™è¡¨è¾¾å¼ä¼˜åŒ–çš„O(n)è§£æ
- ğŸ”„ **å¾ªç¯ç¨³å®š**ï¼šæ™ºèƒ½çš„è¡¨è¾¾å¼åŒ–ç®€ç­–ç•¥
- ğŸ›¡ï¸ **é”™è¯¯å®¹å¿**ï¼šAgentå¤±è´¥æ—¶çš„å¤‡ç”¨è®¡ç®—
- ğŸ’¾ **çŠ¶æ€è½»é‡**ï¼šæœ€å°åŒ–çš„çŠ¶æ€ä¼ é€’

## ğŸ¤ è´¡çŒ®æŒ‡å—

1. Fork é¡¹ç›®
2. åˆ›å»ºç‰¹æ€§åˆ†æ”¯ (`git checkout -b feature/AmazingFeature`)
3. æäº¤æ›´æ”¹ (`git commit -m 'Add some AmazingFeature'`)
4. æ¨é€åˆ†æ”¯ (`git push origin feature/AmazingFeature`)
5. åˆ›å»º Pull Request

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ - æŸ¥çœ‹ [LICENSE](LICENSE) æ–‡ä»¶äº†è§£è¯¦æƒ…ã€‚

## ğŸ™ è‡´è°¢

- [LangGraph](https://github.com/langchain-ai/langgraph) - æ ¸å¿ƒå›¾æ‰§è¡Œå¼•æ“
- [Qwen](https://dashscope.console.aliyun.com/) - AIæ¨¡å‹æ”¯æŒ
- [Pydantic](https://pydantic-docs.helpmanual.io/) - æ•°æ®éªŒè¯æ¡†æ¶

---

ğŸ“§ **è”ç³»æ–¹å¼**: å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·åˆ›å»º Issue æˆ– Pull Requestã€‚

â­ **å¦‚æœè¿™ä¸ªé¡¹ç›®å¯¹æ‚¨æœ‰å¸®åŠ©ï¼Œè¯·ç»™ä¸ªStarï¼**
